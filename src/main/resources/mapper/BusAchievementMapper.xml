<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cubic.api.mapper.BusAchievementMapper">
  <resultMap id="BaseResultMap" type="com.cubic.api.model.BusAchievement">
    <!--
      WARNING - @mbg.generated
    -->
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="user_name" jdbcType="VARCHAR" property="userName" />
    <result column="house_id" jdbcType="BIGINT" property="houseId" />
    <result column="transaction_id" jdbcType="BIGINT" property="transactionId" />
    <result column="rolenum" jdbcType="VARCHAR" property="rolenum" />
    <result column="proportion" jdbcType="VARCHAR" property="proportion" />
    <result column="price" jdbcType="VARCHAR" property="price" />
    <result column="examine_type" jdbcType="VARCHAR" property="examineType" />
    <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
  </resultMap>
  
  
  <select id="listMyAchievement" parameterType="Map" resultMap="BaseResultMap">
  SELECT

	  busa.`user_name`,
	  bht.`number` dealNum,
	  bht.`contractnumber` contractNum,
	  busa.`transaction_id`,
	  su.`relname` userrelname,
	  bh.`xiaoqu_name` xiaoquName,
	  CONCAT (GROUP_CONCAT(busa.`rolenum`),",") roleName,
	  SUM( busa.`proportion`) proportion,
	  SUM(busa.`price`) sumprice,
	  bht.create_time
	  

	FROM bus_achievement busa,`bus_house_transaction` bht,`sys_user` su,`bus_house` bh
	WHERE 
	1=1
		<if test="userNameOne!=null">
		AND  busa.user_name=#{userNameOne}
		</if>
		AND busa.examine_type=1
		AND bht.`id`=busa.`transaction_id`
		AND su.`username`=busa.`user_name`
		AND bh.`id`=busa.`house_id`	
		<if test="(createTimeStart!=null and createTimeStart!='') and (createTimeEnd!=null and createTimeEnd!='')">
			<![CDATA[AND  DATE(busa.create_time) > #{createTimeStart} AND DATE(busa.create_time) < #{createTimeEnd}]]>
		</if>
		<if test="(createTimeStart!=null and createTimeStart!='')  and (createTimeEnd==null or createTimeEnd=='')">
			<![CDATA[AND  DATE(busa.create_time) > #{createTimeStart}]]>
		</if>
		<if test="(createTimeStart==null or createTimeStart=='') and (createTimeEnd!=null and createTimeEnd!='')">
			<![CDATA[ AND DATE(busa.create_time) < #{createTimeEnd}]]>
		</if>
		<if test="userName!=null"><!-- 店长权限能看自己门店的-->
		 AND su.`store_id`=(SELECT store_id FROM sys_user WHERE username=#{userName})
		</if>
		GROUP BY busa.transaction_id
		<if test="userName!=null"><!-- 店长权限排序个人的-->
			,busa.`user_name`
		</if>
		ORDER BY  busa.create_time DESC
  </select>
    
    <select id="listAchievement" parameterType="Map" resultMap="BaseResultMap">
	  SELECT
	  ba.`id`,
	  su.relname userrelname,
	  SUM(price) sumprice
	FROM bus_achievement ba,sys_user su
	WHERE 
		ba.user_name=su.username
		AND ba.examine_type=1
		<if test="type!=null">
			<if test="type==1">
				<![CDATA[ AND DATE(create_time) > DATE(DATE_SUB(NOW(),INTERVAL 7 DAY)) AND  DATE(create_time) <= DATE(NOW())]]>
			</if>
			<if test="type==2">
				<![CDATA[ AND DATE(create_time) > DATE(DATE_SUB(NOW(),INTERVAL 31 DAY)) AND  DATE(create_time) <= DATE(NOW())]]>
			</if>
		</if>

		GROUP BY ba.user_name
		ORDER BY SUM(price) DESC
    </select>
  <select id="examineAchievement" parameterType="Map" resultMap="BaseResultMap">
  	 SELECT
	  busa.`user_name`,
	  su.`relname` userrelname,
	  CONCAT (GROUP_CONCAT(busa.`rolenum`),",") roleName,
	  SUM( busa.`proportion`) proportion,
	  SUM(busa.`price`) sumprice	  
	FROM bus_achievement busa,`bus_house_transaction` bht,`sys_user` su
	WHERE 
	    busa.transaction_id=#{transactionId}
	 	AND bht.`id`=busa.`transaction_id`
		AND su.`username`=busa.`user_name`
		GROUP BY busa.transaction_id,busa.`user_name`	
  </select>
  
  
  <update  id="updateExamineType" parameterType="com.cubic.api.model.BusAchievement">
  	UPDATE bus_achievement
  	SET examine_type = 1;
  	WHERE 
  		transaction_id=#{transactionId}
  	
  </update>
</mapper>